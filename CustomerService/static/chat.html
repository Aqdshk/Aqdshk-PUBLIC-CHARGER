<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PlagSini Support ‚Äî AI Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0A0A1A;
    --card: #12192B;
    --border: #1E2D42;
    --green: #00FF88;
    --cyan: #00E5FF;
    --text: #E8E8E8;
    --text2: #999;
    --red: #FF4444;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body {
    font-family: 'Rajdhani', sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
  .header {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
  }
  .header .bot-avatar {
    width: 40px; height: 40px;
    background: linear-gradient(135deg, var(--green), #00AA55);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    box-shadow: 0 0 15px rgba(0,255,136,0.3);
  }
  .header .info h2 {
    font-size: 16px; font-weight: 700; letter-spacing: 0.5px;
    color: var(--green);
  }
  .header .info p {
    font-size: 11px; color: var(--text2); letter-spacing: 0.5px;
  }
  .header .status {
    margin-left: auto;
    display: flex; align-items: center; gap: 6px;
    font-size: 11px; color: var(--green);
  }
  .header .status::before {
    content: '';
    width: 8px; height: 8px;
    background: var(--green);
    border-radius: 50%;
    animation: pulse-dot 2s infinite;
  }
  @keyframes pulse-dot {
    0%, 100% { opacity: 1; box-shadow: 0 0 4px var(--green); }
    50% { opacity: 0.5; box-shadow: 0 0 8px var(--green); }
  }

  /* ‚îÄ‚îÄ‚îÄ Chat Area ‚îÄ‚îÄ‚îÄ */
  .chat-area {
    flex: 1;
    overflow-y: auto;
    padding: 20px 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  .chat-area::-webkit-scrollbar { width: 4px; }
  .chat-area::-webkit-scrollbar-track { background: transparent; }
  .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  /* Messages */
  .msg {
    display: flex;
    gap: 10px;
    max-width: 85%;
    animation: fadeUp 0.3s ease;
  }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .msg.bot { align-self: flex-start; }
  .msg.user { align-self: flex-end; flex-direction: row-reverse; }
  
  .msg .avatar {
    width: 30px; height: 30px; border-radius: 50%;
    flex-shrink: 0; display: flex;
    align-items: center; justify-content: center;
    font-size: 14px;
  }
  .msg.bot .avatar {
    background: linear-gradient(135deg, var(--green), #00AA55);
  }
  .msg.user .avatar {
    background: var(--border);
    color: var(--cyan);
  }

  .msg .bubble {
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.6;
    letter-spacing: 0.3px;
  }
  .msg.bot .bubble {
    background: var(--card);
    border: 1px solid var(--border);
    border-top-left-radius: 4px;
  }
  .msg.user .bubble {
    background: linear-gradient(135deg, #00CC6A, #009950);
    color: #000;
    border-top-right-radius: 4px;
    font-weight: 500;
  }
  .msg .bubble strong { color: var(--green); }
  .msg.user .bubble strong { color: #000; }

  /* Category buttons */
  .categories {
    display: flex; flex-wrap: wrap; gap: 8px;
    margin-top: 10px;
  }
  .cat-btn {
    padding: 8px 14px;
    background: rgba(0,229,255,0.08);
    border: 1px solid rgba(0,229,255,0.2);
    border-radius: 20px;
    color: var(--cyan);
    font-family: 'Rajdhani', sans-serif;
    font-size: 13px; font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  .cat-btn:hover {
    background: rgba(0,229,255,0.15);
    border-color: var(--cyan);
    box-shadow: 0 0 10px rgba(0,229,255,0.2);
  }

  /* Question buttons */
  .question-btn {
    display: block;
    width: 100%;
    padding: 10px 14px;
    margin-top: 6px;
    background: rgba(0,255,136,0.06);
    border: 1px solid rgba(0,255,136,0.15);
    border-radius: 10px;
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    font-size: 13px; font-weight: 500;
    cursor: pointer;
    text-align: left;
    transition: all 0.2s;
  }
  .question-btn:hover {
    background: rgba(0,255,136,0.12);
    border-color: var(--green);
  }

  /* Suggestion chips */
  .suggestions {
    display: flex; flex-wrap: wrap; gap: 6px;
    margin-top: 8px;
  }
  .sug-btn {
    padding: 6px 12px;
    background: rgba(0,255,136,0.06);
    border: 1px solid rgba(0,255,136,0.15);
    border-radius: 16px;
    color: var(--green);
    font-family: 'Rajdhani', sans-serif;
    font-size: 12px; font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  .sug-btn:hover {
    background: rgba(0,255,136,0.15);
    border-color: var(--green);
  }

  /* Typing indicator */
  .typing {
    display: flex; gap: 4px;
    padding: 12px 16px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    border-top-left-radius: 4px;
    align-self: flex-start;
    margin-left: 40px;
  }
  .typing span {
    width: 6px; height: 6px;
    background: var(--cyan);
    border-radius: 50%;
    animation: bounce 1.4s infinite;
  }
  .typing span:nth-child(2) { animation-delay: 0.2s; }
  .typing span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce {
    0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
    40% { transform: translateY(-6px); opacity: 1; }
  }

  /* ‚îÄ‚îÄ‚îÄ Input Area ‚îÄ‚îÄ‚îÄ */
  .input-area {
    background: var(--card);
    border-top: 1px solid var(--border);
    padding: 16px 24px;
    display: flex;
    gap: 10px;
    flex-shrink: 0;
  }
  .input-area input {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px 16px;
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    font-size: 14px;
    font-weight: 500;
    outline: none;
    transition: border-color 0.2s;
  }
  .input-area input:focus {
    border-color: var(--cyan);
    box-shadow: 0 0 8px rgba(0,229,255,0.15);
  }
  .input-area input::placeholder { color: #555; }
  .input-area button {
    background: linear-gradient(135deg, var(--green), #00AA55);
    border: none;
    border-radius: 12px;
    padding: 0 20px;
    color: #000;
    font-family: 'Rajdhani', sans-serif;
    font-size: 14px; font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.5px;
  }
  .input-area button:hover {
    box-shadow: 0 0 15px rgba(0,255,136,0.4);
    transform: translateY(-1px);
  }
  .input-area button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  /* ‚îÄ‚îÄ‚îÄ Ticket Form Modal ‚îÄ‚îÄ‚îÄ */
  .modal-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 100;
    justify-content: center; align-items: center;
  }
  .modal-overlay.show { display: flex; }
  .modal {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    width: 90%; max-width: 450px;
    animation: fadeUp 0.3s ease;
  }
  .modal h3 {
    color: var(--green);
    font-size: 18px; margin-bottom: 16px;
    letter-spacing: 0.5px;
  }
  .modal label {
    display: block;
    font-size: 12px; color: var(--text2);
    text-transform: uppercase; letter-spacing: 1px;
    margin-bottom: 6px; margin-top: 12px;
  }
  .modal input, .modal textarea, .modal select {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    font-size: 14px; font-weight: 500;
    outline: none;
  }
  .modal textarea { resize: vertical; min-height: 80px; }
  .modal input:focus, .modal textarea:focus, .modal select:focus {
    border-color: var(--cyan);
  }
  .modal .btn-row {
    display: flex; gap: 10px; margin-top: 20px;
  }
  .modal .btn-submit {
    flex: 1;
    background: linear-gradient(135deg, var(--green), #00AA55);
    border: none; border-radius: 10px;
    padding: 12px;
    color: #000; font-family: 'Rajdhani', sans-serif;
    font-size: 14px; font-weight: 700;
    cursor: pointer;
    letter-spacing: 0.5px;
  }
  .modal .btn-cancel {
    padding: 12px 20px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text2);
    font-family: 'Rajdhani', sans-serif;
    font-size: 14px; font-weight: 600;
    cursor: pointer;
  }

  /* Markdown-like formatting in messages */
  .bubble p { margin-bottom: 8px; }
  .bubble p:last-child { margin-bottom: 0; }

  /* Nav tabs */
  .nav-tabs {
    display: flex;
    gap: 0;
    background: var(--card);
    border-bottom: 1px solid var(--border);
  }
  .nav-tab {
    flex: 1;
    padding: 10px;
    text-align: center;
    font-size: 13px;
    font-weight: 600;
    color: var(--text2);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }
  .nav-tab.active {
    color: var(--green);
    border-bottom-color: var(--green);
  }
  .nav-tab:hover { color: var(--text); }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="bot-avatar">‚ö°</div>
  <div class="info">
    <h2>PlagSini Assistant</h2>
    <p>AI-Powered Support Bot</p>
  </div>
  <div class="status">Online</div>
</div>

<!-- Nav -->
<div class="nav-tabs">
  <div class="nav-tab active" onclick="switchTab('chat')">üí¨ Chat</div>
  <div class="nav-tab" onclick="switchTab('tickets')">üìã My Tickets</div>
</div>

<!-- Chat Area -->
<div class="chat-area" id="chatArea"></div>

<!-- Tickets Area (hidden by default) -->
<div class="chat-area" id="ticketsArea" style="display:none;">
  <div style="text-align:center; padding:40px 0;">
    <p style="color:var(--text2); margin-bottom:12px;">Enter your email to view tickets:</p>
    <div style="display:flex; gap:8px; max-width:350px; margin:0 auto;">
      <input id="ticketEmailInput" type="email" placeholder="your@email.com"
        style="flex:1; background:var(--bg); border:1px solid var(--border); border-radius:10px; padding:10px 14px;
        color:var(--text); font-family:'Rajdhani',sans-serif; font-size:14px; outline:none;">
      <button onclick="loadTickets()" style="background:linear-gradient(135deg,var(--green),#00AA55);
        border:none; border-radius:10px; padding:10px 18px; color:#000;
        font-family:'Rajdhani',sans-serif; font-weight:700; cursor:pointer;">VIEW</button>
    </div>
    <div id="ticketsList" style="margin-top:20px; text-align:left;"></div>
  </div>
</div>

<!-- Input -->
<div class="input-area" id="inputArea">
  <input type="text" id="msgInput" placeholder="Type your message..."
    onkeydown="if(event.key==='Enter')sendMsg()">
  <button onclick="sendMsg()" id="sendBtn">SEND</button>
</div>

<!-- Ticket Form Modal -->
<div class="modal-overlay" id="ticketModal">
  <div class="modal">
    <h3>üì© Create Support Ticket</h3>
    <label>Email *</label>
    <input id="tEmail" type="email" placeholder="your@email.com">
    <label>Name</label>
    <input id="tName" placeholder="Your name (optional)">
    <label>Subject *</label>
    <input id="tSubject" placeholder="Brief summary of your issue">
    <label>Category</label>
    <select id="tCategory">
      <option value="general">‚ùì General</option>
      <option value="login_account">üîê Login & Account</option>
      <option value="charging">‚ö° Charging Issues</option>
      <option value="wallet_payment">üí≥ Wallet & Payment</option>
      <option value="vehicle">üöó Vehicle</option>
      <option value="rewards">üéÅ Rewards</option>
      <option value="app_issue">üì± App Problems</option>
    </select>
    <label>Description *</label>
    <textarea id="tDesc" placeholder="Describe your issue in detail..."></textarea>
    <div class="btn-row">
      <button class="btn-cancel" onclick="closeTicketModal()">Cancel</button>
      <button class="btn-submit" onclick="submitTicket()">Submit Ticket</button>
    </div>
  </div>
</div>

<script>
const API = window.location.origin;
let sessionId = null;
let currentCategory = null;
let categoriesCache = {};

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ
async function init() {
  const res = await fetch(`${API}/api/bot/welcome`, { method: 'POST' });
  const data = await res.json();
  if (data.success) {
    // Cache categories for later use
    if (data.data.categories) {
      data.data.categories.forEach(c => categoriesCache[c.id] = c);
    }
    addBotMessage(data.data.message, data.data.categories);
  }
}

// ‚îÄ‚îÄ‚îÄ Chat ‚îÄ‚îÄ‚îÄ
function addBotMessage(text, categories = null, questions = null, suggestions = null) {
  const chatArea = document.getElementById('chatArea');
  const msg = document.createElement('div');
  msg.className = 'msg bot';
  
  let html = `<div class="avatar">‚ö°</div><div class="bubble">`;
  html += formatMarkdown(text);
  
  if (categories) {
    html += `<div class="categories">`;
    categories.forEach(cat => {
      html += `<button class="cat-btn" onclick="selectCategory('${cat.id}')">${cat.label}</button>`;
    });
    html += `</div>`;
  }
  
  if (questions) {
    questions.forEach(q => {
      html += `<button class="question-btn" onclick="askQuestion('${escapeHtml(q.text)}')">${q.text}</button>`;
    });
  }
  
  if (suggestions) {
    html += `<div class="suggestions">`;
    suggestions.forEach(s => {
      if (s.includes('ticket')) {
        html += `<button class="sug-btn" onclick="openTicketModal()" style="border-color:var(--cyan);color:var(--cyan);">üì© ${s}</button>`;
      } else {
        html += `<button class="sug-btn" onclick="askQuestion('${escapeHtml(s)}')">${s}</button>`;
      }
    });
    html += `</div>`;
  }
  
  html += `</div>`;
  msg.innerHTML = html;
  chatArea.appendChild(msg);
  chatArea.scrollTop = chatArea.scrollHeight;
}

function addUserMessage(text) {
  const chatArea = document.getElementById('chatArea');
  const msg = document.createElement('div');
  msg.className = 'msg user';
  msg.innerHTML = `<div class="avatar">üë§</div><div class="bubble">${escapeHtml(text)}</div>`;
  chatArea.appendChild(msg);
  chatArea.scrollTop = chatArea.scrollHeight;
}

function showTyping() {
  const chatArea = document.getElementById('chatArea');
  const typing = document.createElement('div');
  typing.className = 'typing';
  typing.id = 'typingIndicator';
  typing.innerHTML = '<span></span><span></span><span></span>';
  chatArea.appendChild(typing);
  chatArea.scrollTop = chatArea.scrollHeight;
}

function hideTyping() {
  const el = document.getElementById('typingIndicator');
  if (el) el.remove();
}

async function sendMsg() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text) return;
  
  input.value = '';
  addUserMessage(text);
  showTyping();
  
  document.getElementById('sendBtn').disabled = true;
  
  try {
    const res = await fetch(`${API}/api/bot/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: text,
        session_id: sessionId,
        category: currentCategory,
      })
    });
    const data = await res.json();
    hideTyping();
    
    if (data.success) {
      sessionId = data.data.session_id;
      
      if (data.data.type === 'escalate' || data.data.needs_ticket) {
        addBotMessage(data.data.message, null, null, data.data.suggestions || null);
        if (data.data.needs_ticket) {
          setTimeout(() => openTicketModal(), 800);
        }
      } else if (data.data.type === 'greeting') {
        // Re-show categories on greeting
        const cats = Object.keys(categoriesCache).length > 0 ? Object.values(categoriesCache) : null;
        addBotMessage(data.data.message, cats, null, data.data.suggestions || null);
        // Fetch categories if not cached
        if (!cats) {
          fetch(`${API}/api/bot/welcome`, { method: 'POST' })
            .then(r => r.json())
            .then(d => {
              if (d.success && d.data.categories) {
                d.data.categories.forEach(c => categoriesCache[c.id] = c);
              }
            });
        }
      } else {
        addBotMessage(
          data.data.message,
          null,
          null,
          data.data.suggestions || null
        );
      }
    }
  } catch (err) {
    hideTyping();
    addBotMessage("Sorry, I'm having trouble connecting. Please try again.");
  }
  
  document.getElementById('sendBtn').disabled = false;
  input.focus();
}

async function selectCategory(catId) {
  currentCategory = catId;
  addUserMessage(document.querySelector(`[onclick="selectCategory('${catId}')"]`).textContent);
  showTyping();
  
  try {
    const res = await fetch(`${API}/api/bot/category`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ category_id: catId })
    });
    const data = await res.json();
    hideTyping();
    
    if (data.success) {
      addBotMessage(data.data.message, null, data.data.questions);
    }
  } catch (err) {
    hideTyping();
    addBotMessage("Something went wrong. Please try again.");
  }
}

function askQuestion(text) {
  document.getElementById('msgInput').value = text;
  sendMsg();
}

// ‚îÄ‚îÄ‚îÄ Ticket Modal ‚îÄ‚îÄ‚îÄ
function openTicketModal() {
  document.getElementById('ticketModal').classList.add('show');
  // Pre-fill category if detected
  if (currentCategory) {
    document.getElementById('tCategory').value = currentCategory;
  }
}

function closeTicketModal() {
  document.getElementById('ticketModal').classList.remove('show');
}

async function submitTicket() {
  const email = document.getElementById('tEmail').value.trim();
  const name = document.getElementById('tName').value.trim();
  const subject = document.getElementById('tSubject').value.trim();
  const category = document.getElementById('tCategory').value;
  const desc = document.getElementById('tDesc').value.trim();
  
  if (!email || !subject || !desc) {
    alert('Please fill in Email, Subject, and Description.');
    return;
  }
  
  try {
    const res = await fetch(`${API}/api/bot/escalate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email, name, subject, category, description: desc
      })
    });
    const data = await res.json();
    
    closeTicketModal();
    
    if (data.success) {
      addBotMessage(
        `‚úÖ **Ticket Created Successfully!**\n\n` +
        `üìã Ticket ID: **${data.data.ticket_number}**\n` +
        `üìÇ Category: ${data.data.category}\n` +
        `üî¥ Priority: ${data.data.priority.toUpperCase()}\n\n` +
        `üìß A confirmation email has been sent to **${email}**.\n` +
        `Our support team will respond based on priority. You can track your ticket status anytime.`
      );
    } else {
      addBotMessage(`‚ùå Failed to create ticket: ${data.message || 'Unknown error'}`);
    }
  } catch (err) {
    closeTicketModal();
    addBotMessage("‚ùå Network error. Please try again.");
  }
}

// ‚îÄ‚îÄ‚îÄ Tickets Tab ‚îÄ‚îÄ‚îÄ
function switchTab(tab) {
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  
  if (tab === 'chat') {
    document.getElementById('chatArea').style.display = 'flex';
    document.getElementById('ticketsArea').style.display = 'none';
    document.getElementById('inputArea').style.display = 'flex';
  } else {
    document.getElementById('chatArea').style.display = 'none';
    document.getElementById('ticketsArea').style.display = 'flex';
    document.getElementById('inputArea').style.display = 'none';
  }
}

async function loadTickets() {
  const email = document.getElementById('ticketEmailInput').value.trim();
  if (!email) return;
  
  const list = document.getElementById('ticketsList');
  list.innerHTML = '<p style="color:var(--text2); text-align:center;">Loading...</p>';
  
  try {
    const res = await fetch(`${API}/api/tickets?email=${encodeURIComponent(email)}`);
    const data = await res.json();
    
    if (data.success && data.data.tickets.length > 0) {
      let html = '';
      data.data.tickets.forEach(t => {
        const statusColors = {
          open: 'var(--cyan)', in_progress: '#FFD700',
          waiting_user: '#FF8800', resolved: 'var(--green)', closed: '#666'
        };
        const color = statusColors[t.status] || 'var(--text2)';
        const date = new Date(t.created_at).toLocaleDateString('en-MY', {
          year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
        });
        
        html += `
          <div style="background:var(--card); border:1px solid var(--border); border-radius:12px;
            padding:14px; margin-bottom:10px; cursor:pointer;" onclick="viewTicket(${t.id})">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
              <span style="color:var(--green); font-weight:700; font-size:13px;">${t.ticket_number}</span>
              <span style="color:${color}; font-size:11px; font-weight:600; text-transform:uppercase;
                padding:2px 8px; border:1px solid ${color}; border-radius:10px;">${t.status.replace('_', ' ')}</span>
            </div>
            <p style="font-size:14px; font-weight:600; margin-bottom:4px;">${t.subject}</p>
            <p style="font-size:11px; color:var(--text2);">${date} ¬∑ ${t.priority.toUpperCase()} ¬∑ ${t.category}</p>
          </div>`;
      });
      list.innerHTML = html;
    } else {
      list.innerHTML = '<p style="color:var(--text2); text-align:center; padding:20px;">No tickets found for this email.</p>';
    }
  } catch (err) {
    list.innerHTML = '<p style="color:var(--red); text-align:center;">Failed to load tickets.</p>';
  }
}

async function viewTicket(id) {
  try {
    const res = await fetch(`${API}/api/tickets/${id}`);
    const data = await res.json();
    if (!data.success) return;
    
    const t = data.data;
    const list = document.getElementById('ticketsList');
    
    let html = `
      <button onclick="loadTickets()" style="background:transparent; border:1px solid var(--border);
        border-radius:8px; padding:6px 14px; color:var(--text2); font-family:'Rajdhani',sans-serif;
        font-size:13px; cursor:pointer; margin-bottom:14px;">‚Üê Back</button>
      <div style="background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:14px;">
        <h3 style="color:var(--green); margin-bottom:10px;">${t.ticket_number} ‚Äî ${t.subject}</h3>
        <p style="font-size:12px; color:var(--text2);">
          Status: <strong style="color:var(--cyan);">${t.status.toUpperCase()}</strong> ¬∑
          Priority: <strong>${t.priority.toUpperCase()}</strong> ¬∑
          Category: ${t.category}
        </p>
      </div>`;
    
    t.messages.forEach(m => {
      const isUser = m.sender_type === 'user';
      const isSystem = m.sender_type === 'system';
      const bgColor = isSystem ? 'rgba(0,229,255,0.05)' : isUser ? 'rgba(0,255,136,0.05)' : 'rgba(255,255,255,0.03)';
      const borderColor = isSystem ? 'rgba(0,229,255,0.15)' : isUser ? 'rgba(0,255,136,0.15)' : 'var(--border)';
      const labelColor = isSystem ? 'var(--cyan)' : isUser ? 'var(--green)' : '#FFD700';
      const date = new Date(m.created_at).toLocaleString('en-MY');
      
      html += `
        <div style="background:${bgColor}; border:1px solid ${borderColor}; border-radius:10px;
          padding:12px; margin-bottom:8px;">
          <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
            <span style="color:${labelColor}; font-size:12px; font-weight:700;">${m.sender_name || m.sender_type}</span>
            <span style="color:var(--text2); font-size:10px;">${date}</span>
          </div>
          <p style="font-size:13px; line-height:1.5; ${isSystem ? 'font-style:italic; color:var(--text2);' : ''}">${m.message}</p>
        </div>`;
    });
    
    list.innerHTML = html;
  } catch (err) {
    console.error(err);
  }
}

// ‚îÄ‚îÄ‚îÄ Utils ‚îÄ‚îÄ‚îÄ
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatMarkdown(text) {
  return text
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n/g, '<br>');
}

// Go!
init();
</script>
</body>
</html>
