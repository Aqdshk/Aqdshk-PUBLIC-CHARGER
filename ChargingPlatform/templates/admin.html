<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - User Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css?v=8">
    <style>
        /* Admin-specific overrides (fluid) */
        .sidebar-user { display:flex; align-items:center; gap: clamp(6px, 0.5vw, 10px); padding: clamp(6px, 0.5vw, 10px); background:var(--accent-dim); border-radius:var(--radius-sm); margin-bottom: clamp(4px, 0.4vw, 8px); }
        .sidebar-user-avatar { width: clamp(24px, 1.8vw, 30px); height: clamp(24px, 1.8vw, 30px); background:var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:#000; font-size: clamp(10px, 0.65vw, 12px); }
        .sidebar-user-info { flex:1; }
        .sidebar-user-name { color:#fff; font-size: clamp(10px, 0.65vw, 12px); font-weight:600; }
        .sidebar-user-role { color:var(--accent); font-size: clamp(8px, 0.5vw, 10px); }
        .sidebar-logout { width:100%; padding: clamp(4px, 0.4vw, 7px); background:transparent; border:1px solid var(--red); color:var(--red); border-radius:var(--radius-sm); cursor:pointer; font-size: clamp(9px, 0.55vw, 11px); font-weight:600; transition:all var(--transition); display:flex; align-items:center; justify-content:center; gap:5px; }
        .sidebar-logout:hover { background:var(--red); color:#fff; }
        .actions { display:flex; gap: clamp(3px, 0.3vw, 6px); }
        .table-container { overflow-x:auto; }
        .stat-sub { color:var(--text-muted); font-size: clamp(8px, 0.5vw, 10px); margin-top:2px; }
        @media (max-width:768px) { .form-row { grid-template-columns:1fr; } .table-container { overflow-x:auto; } .search-box { flex-direction:column; } .search-box input { width:100%; max-width:none; } }
    </style>
</head>
<body>
    <script src="/static/auth.js"></script>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">‚ö°</div>
            <div>
                <div class="sidebar-title">PlagSini</div>
                <div class="sidebar-subtitle">Admin Panel</div>
            </div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Management</div>
                <div class="nav-item active" onclick="showTab('users')" id="navUsers"><span class="nav-item-icon">üë•</span><span class="nav-item-text">Users</span></div>
                <div class="nav-item" onclick="showTab('tickets')" id="navTickets"><span class="nav-item-icon">üé´</span><span class="nav-item-text">Support Tickets</span></div>
                <div class="nav-item" onclick="showTab('staff')" id="navStaff"><span class="nav-item-icon">üè¢</span><span class="nav-item-text">Staff</span></div>
                <a href="/my-tickets" class="nav-item"><span class="nav-item-icon">üìã</span><span class="nav-item-text">My Tickets</span></a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Operations</div>
                <a href="/" class="nav-item"><span class="nav-item-icon">üîå</span><span class="nav-item-text">Live Dashboard</span></a>
                <a href="/analytics" class="nav-item"><span class="nav-item-icon">üß†</span><span class="nav-item-text">Analytics & Insights</span></a>
                <a href="/operations" class="nav-item"><span class="nav-item-icon">üéõÔ∏è</span><span class="nav-item-text">OCPP Ops</span></a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Analytics</div>
                <div class="nav-item" onclick="showTab('userStats')" id="navUserStats"><span class="nav-item-icon">üìä</span><span class="nav-item-text">User Stats</span></div>
                <div class="nav-item" onclick="showTab('walletReport')" id="navWalletReport"><span class="nav-item-icon">üí∞</span><span class="nav-item-text">Wallet Report</span></div>
                <div class="nav-item" onclick="showTab('activityLog')" id="navActivityLog"><span class="nav-item-icon">üìà</span><span class="nav-item-text">Activity Log</span></div>
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="sidebar-user">
                <div class="sidebar-user-avatar" id="sidebarAvatar">A</div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name" id="sidebarName">Admin</div>
                    <div class="sidebar-user-role">Administrator</div>
                </div>
            </div>
            <button class="sidebar-logout" onclick="handleLogout()">üö™ Logout</button>
        </div>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Login handled by centralized /login page -->

    <!-- Main Content -->
    <div class="main-content" id="mainContent" style="display: none;">
        <header class="top-header">
            <div class="header-left">
                <div class="hamburger" id="hamburger" onclick="toggleSidebar()"><span></span><span></span><span></span></div>
                <h1 class="page-title">üë• User Management</h1>
            </div>
            <div class="header-right">
                <span class="header-user">Welcome, <strong id="adminName">Admin</strong></span>
                <a href="/" class="btn btn-secondary btn-xs">‚Üê Dashboard</a>
            </div>
        </header>
        <div class="admin-container">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card"><div class="stat-icon">üë•</div><div class="stat-value" id="statTotalUsers">-</div><div class="stat-label">Total Users</div></div>
                <div class="stat-card"><div class="stat-icon">‚úÖ</div><div class="stat-value" id="statActiveUsers">-</div><div class="stat-label">Active</div></div>
                <div class="stat-card"><div class="stat-icon">üõ°Ô∏è</div><div class="stat-value" id="statAdminUsers">-</div><div class="stat-label">Admins</div></div>
                <div class="stat-card"><div class="stat-icon">üí∞</div><div class="stat-value" id="statTotalBalance">-</div><div class="stat-label">Wallet (RM)</div></div>
                <div class="stat-card"><div class="stat-icon">üÜï</div><div class="stat-value" id="statRecentReg">-</div><div class="stat-label">New (7d)</div></div>
            </div>
            <div class="user-controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search users..." onkeyup="handleSearchKeyup(event)">
                    <button class="btn btn-secondary btn-small" onclick="loadUsers()">Search</button>
                </div>
                <button class="btn btn-primary btn-small" onclick="openCreateModal()">+ Add User</button>
            </div>
            <div class="table-container">
                <table class="user-table">
                    <thead><tr><th>ID</th><th>User</th><th>Phone</th><th>Status</th><th>Role</th><th>Wallet</th><th>Registered</th><th>Last Login</th><th>Actions</th></tr></thead>
                    <tbody id="userTableBody"><tr><td colspan="9" class="loading-spinner">Loading users...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ============ SUPPORT TICKETS SECTION ============ -->
    <div class="main-content" id="ticketContent" style="display: none;">
        <header class="top-header">
            <div class="header-left">
                <div class="hamburger" id="hamburger2" onclick="toggleSidebar()"><span></span><span></span><span></span></div>
                <h1 class="page-title">üé´ Support Tickets</h1>
            </div>
            <div class="header-right">
                <span class="header-user">Welcome, <strong id="adminName2">Admin</strong></span>
                <a href="/" class="btn btn-secondary btn-xs">‚Üê Dashboard</a>
            </div>
        </header>
        <div class="admin-container">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-icon">üé´</div><div class="stat-value" id="tStatTotal">-</div><div class="stat-label">Total</div></div>
                <div class="stat-card" style="border-top:2px solid var(--orange);"><div class="stat-icon">üü†</div><div class="stat-value" id="tStatOpen">-</div><div class="stat-label">Open</div></div>
                <div class="stat-card" style="border-top:2px solid var(--blue);"><div class="stat-icon">üîµ</div><div class="stat-value" id="tStatProgress">-</div><div class="stat-label">In Progress</div></div>
                <div class="stat-card" style="border-top:2px solid var(--accent);"><div class="stat-icon">üü¢</div><div class="stat-value" id="tStatResolved">-</div><div class="stat-label">Resolved</div></div>
                <div class="stat-card"><div class="stat-icon">‚ö´</div><div class="stat-value" id="tStatClosed">-</div><div class="stat-label">Closed</div></div>
                <div class="stat-card" style="border-top:2px solid #ff4444;"><div class="stat-icon">üö®</div><div class="stat-value" id="tStatOverdue" style="color:#ff4444;">-</div><div class="stat-label">Overdue</div></div>
                <div class="stat-card" style="border-top:2px solid #ffa500;"><div class="stat-icon">‚ö†Ô∏è</div><div class="stat-value" id="tStatWarning" style="color:#ffa500;">-</div><div class="stat-label">Near SLA</div></div>
            </div>
            <div class="user-controls">
                <div class="search-box">
                    <input type="text" id="ticketSearch" placeholder="Search tickets..." onkeyup="if(event.key==='Enter')loadTickets()">
                    <select id="ticketStatusFilter" onchange="loadTickets()" class="filter-select"><option value="">All Status</option><option value="open">Open</option><option value="in_progress">In Progress</option><option value="resolved">Resolved</option><option value="closed">Closed</option></select>
                    <select id="ticketPriorityFilter" onchange="loadTickets()" class="filter-select"><option value="">All Priority</option><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="urgent">Urgent</option></select>
                    <button class="btn btn-secondary btn-small" onclick="loadTickets()">Search</button>
                </div>
            </div>
            <div class="table-container">
                <table class="user-table">
                    <thead><tr><th>Ticket #</th><th>User</th><th>Category</th><th>Subject</th><th>Priority</th><th>Status</th><th>SLA</th><th>Dept</th><th>Assigned</th><th>Created</th><th></th></tr></thead>
                    <tbody id="ticketTableBody"><tr><td colspan="11" class="loading-spinner">Loading tickets...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ============ STAFF MANAGEMENT SECTION ============ -->
    <div class="main-content" id="staffContent" style="display: none;">
        <header class="top-header">
            <div class="header-left">
                <div class="hamburger" onclick="toggleSidebar()"><span></span><span></span><span></span></div>
                <h1 class="page-title">üè¢ Staff Management</h1>
            </div>
            <div class="header-right">
                <span class="header-user">Welcome, <strong id="adminName3">Admin</strong></span>
                <a href="/" class="btn btn-secondary btn-xs">‚Üê Dashboard</a>
            </div>
        </header>
        <div class="admin-container">
            <div class="stats-grid" id="staffDeptStats"></div>
            <div class="user-controls">
                <div class="search-box">
                    <select id="staffDeptFilter" onchange="loadStaff()" class="filter-select"><option value="">All Departments</option><option value="IT">IT</option><option value="Operations">Operations</option><option value="Finance">Finance</option><option value="Marketing">Marketing</option><option value="Customer Service">Customer Service</option></select>
                    <select id="staffRoleFilter" onchange="loadStaff()" class="filter-select"><option value="">All Roles</option><option value="admin">Admin</option><option value="manager">Manager</option><option value="staff">Staff</option></select>
                </div>
                <button class="btn btn-primary btn-small" onclick="openStaffModal()">+ Add Staff</button>
            </div>
            <div class="table-container">
                <table class="user-table">
                    <thead><tr><th>ID</th><th>Name</th><th>Dept</th><th>Role</th><th>Tickets</th><th>Max</th><th>Status</th><th>Last Login</th><th></th></tr></thead>
                    <tbody id="staffTableBody"><tr><td colspan="9" class="loading-spinner">Loading staff...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ============ USER STATISTICS REPORT ============ -->
    <div class="main-content" id="userStatsContent" style="display: none;">
        <header class="top-header">
            <div class="header-left">
                <div class="hamburger" onclick="toggleSidebar()"><span></span><span></span><span></span></div>
                <h1 class="page-title">üìä User Statistics</h1>
            </div>
            <div class="header-right"><span class="header-user">Welcome, <strong id="adminName4">Admin</strong></span><a href="/" class="btn btn-secondary btn-xs">‚Üê Dashboard</a></div>
        </header>
        <div class="admin-container">
            <div class="stats-grid" id="userReportStats"></div>
            <div class="card" style="margin-bottom:16px;">
                <div class="card-header"><span class="card-title">üìà Registration Trend (30d)</span></div>
                <div class="card-body"><div id="regTrendChart" style="display:flex;align-items:flex-end;gap:2px;height:120px;overflow-x:auto;"></div></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                <div class="card"><div class="card-header"><span class="card-title">üîë Login Activity</span></div><div class="card-body" id="loginStatsBox"></div></div>
                <div class="card"><div class="card-header"><span class="card-title">üÜï Newest Users</span></div><div class="card-body" id="newestUsersBox" style="max-height:260px;overflow-y:auto;"></div></div>
            </div>
        </div>
    </div>

    <!-- ============ WALLET REPORT ============ -->
    <div class="main-content" id="walletReportContent" style="display: none;">
        <header class="top-header">
            <div class="header-left">
                <div class="hamburger" onclick="toggleSidebar()"><span></span><span></span><span></span></div>
                <h1 class="page-title">üí∞ Wallet Reports</h1>
            </div>
            <div class="header-right"><span class="header-user">Welcome, <strong id="adminName5">Admin</strong></span><a href="/" class="btn btn-secondary btn-xs">‚Üê Dashboard</a></div>
        </header>
        <div class="admin-container">
            <div class="stats-grid" id="walletSummaryStats"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
                <div class="card"><div class="card-header"><span class="card-title">üìä Balance Distribution</span></div><div class="card-body" id="balanceDistChart"></div></div>
                <div class="card"><div class="card-header"><span class="card-title">üèÜ Top Wallets</span></div><div class="card-body" id="topWalletsBox" style="max-height:260px;overflow-y:auto;"></div></div>
            </div>
            <div class="card">
                <div class="card-header"><span class="card-title">üí≥ Recent Transactions</span></div>
                <div class="card-body" style="padding:0;">
                    <table class="user-table"><thead><tr><th>User</th><th>Type</th><th>Amount (RM)</th><th>Description</th><th>Date</th></tr></thead><tbody id="walletTxnBody"><tr><td colspan="5" class="loading-spinner">Loading...</td></tr></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ ACTIVITY LOG ============ -->
    <div class="main-content" id="activityLogContent" style="display: none;">
        <header class="top-header">
            <div class="header-left">
                <div class="hamburger" onclick="toggleSidebar()"><span></span><span></span><span></span></div>
                <h1 class="page-title">üìà Activity Log</h1>
            </div>
            <div class="header-right"><span class="header-user">Welcome, <strong id="adminName6">Admin</strong></span><a href="/" class="btn btn-secondary btn-xs">‚Üê Dashboard</a></div>
        </header>
        <div class="admin-container">
            <div class="user-controls">
                <div class="search-box">
                    <select id="activityTypeFilter" onchange="filterActivityLog()" class="filter-select"><option value="">All Events</option><option value="registration">üë§ Registrations</option><option value="login">üîë Logins</option><option value="session">‚ö° Sessions</option><option value="ticket">üé´ Tickets</option><option value="maintenance">üîß Maintenance</option><option value="staff_login">üè¢ Staff Logins</option></select>
                    <button class="btn btn-secondary btn-small" onclick="loadActivityLog()">üîÑ Refresh</button>
                </div>
            </div>
            <div class="card"><div class="card-body"><div id="activityTimeline" style="max-height:520px;overflow-y:auto;"></div></div></div>
        </div>
    </div>

    <!-- Staff Create/Edit Modal -->
    <div class="modal" id="staffModal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="staffModalTitle">Add Staff</h3><button class="modal-close" onclick="closeStaffModal()">&times;</button></div>
            <form id="staffForm" onsubmit="handleStaffSubmit(event)">
                <input type="hidden" id="editStaffId">
                <div class="form-group"><label>Name *</label><input type="text" id="sfName" required placeholder="Full Name"></div>
                <div class="form-group"><label>Email *</label><input type="email" id="sfEmail" required placeholder="staff@plagsini.com"></div>
                <div class="form-group" id="sfPasswordGroup"><label>Password *</label><input type="password" id="sfPassword" placeholder="Password"><small style="color:var(--text-muted);font-size:10px;display:block;margin-top:3px;" id="sfPwHint"></small></div>
                <div class="form-row">
                    <div class="form-group"><label>Department *</label><select id="sfDept" required><option value="IT">IT</option><option value="Operations">Operations</option><option value="Finance">Finance</option><option value="Marketing">Marketing</option><option value="Customer Service">Customer Service</option></select></div>
                    <div class="form-group"><label>Role *</label><select id="sfRole" required><option value="staff">Staff</option><option value="manager">Manager</option><option value="admin">Admin</option></select></div>
                </div>
                <div class="form-group"><label>Max Tickets</label><input type="number" id="sfMaxTickets" value="10" min="1" max="50"></div>
                <div class="form-group"><div class="checkbox-group"><input type="checkbox" id="sfActive" checked><label for="sfActive">Active</label></div></div>
                <div class="modal-actions"><button type="button" class="btn btn-secondary btn-small" onclick="closeStaffModal()">Cancel</button><button type="submit" class="btn btn-primary btn-small" id="sfSubmitBtn">Create Staff</button></div>
            </form>
        </div>
    </div>

    <!-- Ticket Detail Modal -->
    <div class="modal" id="ticketModal">
        <div class="modal-content" style="max-width:640px;">
            <div class="modal-header"><h3 id="ticketModalTitle">Ticket Details</h3><button class="modal-close" onclick="closeTicketModal()">&times;</button></div>
            <div id="ticketDetail" style="padding:0 14px 14px;"></div>
        </div>
    </div>

    <!-- Create/Edit User Modal -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modalTitle">Add New User</h3><button class="modal-close" onclick="closeModal()">&times;</button></div>
            <form id="userForm" onsubmit="handleSubmitUser(event)">
                <input type="hidden" id="editUserId">
                <div class="form-group"><label>Email *</label><input type="email" id="userEmail" required placeholder="user@example.com"></div>
                <div class="form-group" id="passwordGroup"><label>Password *</label><input type="password" id="userPassword" placeholder="Enter password"><small style="color:var(--text-muted);font-size:10px;margin-top:3px;display:block;" id="passwordHint">Leave empty to keep current</small></div>
                <div class="form-row">
                    <div class="form-group"><label>Full Name</label><input type="text" id="userName" placeholder="John Doe"></div>
                    <div class="form-group"><label>Phone</label><input type="tel" id="userPhone" placeholder="+60123456789"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Wallet (RM)</label><input type="number" id="userBalance" step="0.01" min="0" value="0"></div>
                    <div class="form-group"><label>Points</label><input type="number" id="userPoints" min="0" value="0"></div>
                </div>
                <div class="form-group"><div class="checkbox-group"><input type="checkbox" id="userActive" checked><label for="userActive">Active</label></div></div>
                <div class="form-group"><div class="checkbox-group"><input type="checkbox" id="userVerified"><label for="userVerified">Verified</label></div></div>
                <div class="form-group"><div class="checkbox-group"><input type="checkbox" id="userAdmin"><label for="userAdmin">Admin</label></div></div>
                <div class="modal-actions"><button type="button" class="btn btn-secondary btn-small" onclick="closeModal()">Cancel</button><button type="submit" class="btn btn-primary btn-small" id="submitBtn">Create User</button></div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content" style="max-width:380px;">
            <div class="modal-header"><h3>‚ö†Ô∏è Confirm Delete</h3><button class="modal-close" onclick="closeDeleteModal()">&times;</button></div>
            <div style="padding:0 18px;">
                <p style="color:var(--text-secondary);font-size:12px;line-height:1.6;margin-bottom:12px;">Delete user <strong id="deleteUserEmail" style="color:var(--red);"></strong>?<br><span style="color:var(--text-muted);font-size:11px;">This also deletes their wallet and transactions. Cannot be undone.</span></p>
            </div>
            <input type="hidden" id="deleteUserId">
            <div class="modal-actions"><button class="btn btn-secondary btn-small" onclick="closeDeleteModal()">Cancel</button><button class="btn btn-danger btn-small" onclick="confirmDelete()">Delete</button></div>
        </div>
    </div>

    <script>
        // Auth handled by /static/auth.js (redirects non-admin to / and non-auth to /login)
        // Compat layer ‚Äî keep adminToken/adminName references working
        const staffToken = localStorage.getItem('staffToken');
        const staffInfo = JSON.parse(localStorage.getItem('staffInfo') || 'null');
        let adminToken = staffToken;
        let adminName = staffInfo ? staffInfo.name : 'Admin';

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const hamburger = document.getElementById('hamburger');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            hamburger.classList.toggle('active');
        }

        // Check if logged in
        function checkAuth() {
            if (adminToken) {
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('adminName').textContent = adminName || 'Admin';
                document.getElementById('sidebarName').textContent = adminName || 'Admin';
                document.getElementById('sidebarAvatar').textContent = (adminName || 'A')[0].toUpperCase();
                loadStats();
                loadUsers();
            } else {
                window.location.href = '/login';
            }
        }

        // Logout ‚Äî use shared logout from auth.js
        function handleLogout() {
            window._psLogout();
        }

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch(`/api/admin/stats?admin_token=${adminToken}`);
                const data = await response.json();

                document.getElementById('statTotalUsers').textContent = data.total_users || 0;
                document.getElementById('statActiveUsers').textContent = data.active_users || 0;
                document.getElementById('statAdminUsers').textContent = data.admin_users || 0;
                document.getElementById('statTotalBalance').textContent = (data.total_wallet_balance || 0).toFixed(2);
                document.getElementById('statRecentReg').textContent = data.recent_registrations || 0;
            } catch (e) {
                console.error('Error loading stats:', e);
            }
        }

        // Load users
        async function loadUsers() {
            const search = document.getElementById('searchInput').value;
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '<tr><td colspan="9" class="loading-spinner">Loading users...</td></tr>';

            try {
                let url = `/api/admin/users?admin_token=${adminToken}&limit=100`;
                if (search) {
                    url += `&search=${encodeURIComponent(search)}`;
                }

                const response = await fetch(url);
                
                if (response.status === 403) {
                    handleLogout();
                    return;
                }

                const users = await response.json();

                if (users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="empty-state">
                                <div class="empty-state-icon">üì≠</div>
                                <div>No users found</div>
                            </td>
                        </tr>`;
                    return;
                }

                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td style="color:var(--text-muted);">${user.id}</td>
                        <td><div class="user-name">${user.name || 'No name'}</div><div class="user-email">${user.email}</div></td>
                        <td>${user.phone || '<span style="color:var(--text-muted)">-</span>'}</td>
                        <td>${user.is_active ? '<span class="badge badge-success">Active</span>' : '<span class="badge badge-danger">Inactive</span>'}${user.is_verified ? ' <span class="badge badge-info">Verified</span>' : ''}</td>
                        <td>${user.is_admin ? '<span class="badge badge-warning">Admin</span>' : '<span class="badge badge-success">User</span>'}</td>
                        <td><div class="wallet-info"><span class="wallet-balance">RM ${user.wallet_balance.toFixed(2)}</span><span class="wallet-points">${user.wallet_points} pts</span></div></td>
                        <td style="font-size:11px;">${formatDate(user.created_at)}</td>
                        <td style="font-size:11px;">${user.last_login ? formatDate(user.last_login) : '<span style="color:var(--text-muted)">Never</span>'}</td>
                        <td><div class="actions"><button class="btn btn-secondary btn-xs" onclick="openEditModal(${user.id})">Edit</button><button class="btn btn-danger btn-xs" onclick="openDeleteModal(${user.id}, '${user.email}')">Del</button></div></td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Error loading users:', e);
                tbody.innerHTML = '<tr><td colspan="9" class="loading-spinner">Error loading users</td></tr>';
            }
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-MY', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Search on Enter
        function handleSearchKeyup(event) {
            if (event.key === 'Enter') {
                loadUsers();
            }
        }

        // Open create modal
        function openCreateModal() {
            // Close sidebar if open
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').classList.remove('active');
            document.getElementById('hamburger').classList.remove('active');

            document.getElementById('modalTitle').textContent = 'Add New User';
            document.getElementById('submitBtn').textContent = 'Create User';
            document.getElementById('editUserId').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userEmail').disabled = false;
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').required = true;
            document.getElementById('passwordHint').style.display = 'none';
            document.getElementById('userName').value = '';
            document.getElementById('userPhone').value = '';
            document.getElementById('userBalance').value = '0';
            document.getElementById('userPoints').value = '0';
            document.getElementById('userActive').checked = true;
            document.getElementById('userVerified').checked = false;
            document.getElementById('userAdmin').checked = false;
            document.getElementById('userModal').classList.add('active');
        }

        // Open edit modal
        async function openEditModal(userId) {
            try {
                const response = await fetch(`/api/admin/users/${userId}?admin_token=${adminToken}`);
                const user = await response.json();

                document.getElementById('modalTitle').textContent = 'Edit User';
                document.getElementById('submitBtn').textContent = 'Save Changes';
                document.getElementById('editUserId').value = user.id;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userEmail').disabled = true;
                document.getElementById('userPassword').value = '';
                document.getElementById('userPassword').required = false;
                document.getElementById('passwordHint').style.display = 'block';
                document.getElementById('userName').value = user.name || '';
                document.getElementById('userPhone').value = user.phone || '';
                document.getElementById('userBalance').value = user.wallet_balance || 0;
                document.getElementById('userPoints').value = user.wallet_points || 0;
                document.getElementById('userActive').checked = user.is_active;
                document.getElementById('userVerified').checked = user.is_verified;
                document.getElementById('userAdmin').checked = user.is_admin;
                document.getElementById('userModal').classList.add('active');
            } catch (e) {
                alert('Error loading user details');
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('userModal').classList.remove('active');
        }

        // Submit user form
        async function handleSubmitUser(event) {
            event.preventDefault();

            const userId = document.getElementById('editUserId').value;
            const isEdit = !!userId;

            const data = {
                name: document.getElementById('userName').value,
                phone: document.getElementById('userPhone').value || null,
                is_active: document.getElementById('userActive').checked,
                is_verified: document.getElementById('userVerified').checked,
                is_admin: document.getElementById('userAdmin').checked,
                wallet_balance: parseFloat(document.getElementById('userBalance').value) || 0,
                wallet_points: parseInt(document.getElementById('userPoints').value) || 0
            };

            if (isEdit) {
                // Edit mode
                const password = document.getElementById('userPassword').value;
                if (password) {
                    data.new_password = password;
                }

                try {
                    const response = await fetch(`/api/admin/users/${userId}?admin_token=${adminToken}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        closeModal();
                        loadUsers();
                        loadStats();
                    } else {
                        alert(result.detail || 'Error updating user');
                    }
                } catch (e) {
                    alert('Error updating user');
                }
            } else {
                // Create mode
                data.email = document.getElementById('userEmail').value;
                data.password = document.getElementById('userPassword').value;

                if (!data.password) {
                    alert('Password is required');
                    return;
                }

                try {
                    const response = await fetch(`/api/admin/users?admin_token=${adminToken}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        closeModal();
                        loadUsers();
                        loadStats();
                    } else {
                        alert(result.detail || 'Error creating user');
                    }
                } catch (e) {
                    alert('Error creating user');
                }
            }
        }

        // Delete modal
        function openDeleteModal(userId, email) {
            document.getElementById('deleteUserId').value = userId;
            document.getElementById('deleteUserEmail').textContent = email;
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
        }

        async function confirmDelete() {
            const userId = document.getElementById('deleteUserId').value;

            try {
                const response = await fetch(`/api/admin/users/${userId}?admin_token=${adminToken}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    closeDeleteModal();
                    loadUsers();
                    loadStats();
                } else {
                    alert(result.detail || 'Error deleting user');
                }
            } catch (e) {
                alert('Error deleting user');
            }
        }

        // ============ TAB SWITCHING ============
        const ALL_TABS = ['users','tickets','staff','userStats','walletReport','activityLog'];
        const TAB_MAP = {
            users:        {content:'mainContent',       nav:'navUsers'},
            tickets:      {content:'ticketContent',     nav:'navTickets'},
            staff:        {content:'staffContent',      nav:'navStaff'},
            userStats:    {content:'userStatsContent',  nav:'navUserStats'},
            walletReport: {content:'walletReportContent',nav:'navWalletReport'},
            activityLog:  {content:'activityLogContent',nav:'navActivityLog'},
        };

        function showTab(tab) {
            // Close sidebar
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').classList.remove('active');
            document.querySelectorAll('.hamburger').forEach(h => h.classList.remove('active'));

            // Hide all content + deactivate all nav
            ALL_TABS.forEach(t => {
                const m = TAB_MAP[t];
                const el = document.getElementById(m.content); if(el) el.style.display = 'none';
                const nv = document.getElementById(m.nav);     if(nv) nv.classList.remove('active');
            });

            // Show selected
            const selected = TAB_MAP[tab];
            if (selected) {
                const el = document.getElementById(selected.content); if(el) el.style.display = 'block';
                const nv = document.getElementById(selected.nav);     if(nv) nv.classList.add('active');
            }

            // Update admin name in new tabs
            ['adminName2','adminName3','adminName4','adminName5','adminName6'].forEach(id => {
                const el = document.getElementById(id); if(el) el.textContent = adminName || 'Admin';
            });

            // Load data per tab
            if (tab === 'tickets')      { loadTicketStats(); loadTickets(); }
            else if (tab === 'staff')   { loadStaff(); loadDeptStats(); }
            else if (tab === 'userStats')    { loadUserStatsReport(); }
            else if (tab === 'walletReport') { loadWalletReport(); }
            else if (tab === 'activityLog')  { loadActivityLog(); }
        }

        // Override checkAuth to handle all panels
        const _origCheckAuth = checkAuth;
        checkAuth = function() {
            if (adminToken) {
                // Hide everything first
                ALL_TABS.forEach(t => {
                    const el = document.getElementById(TAB_MAP[t].content); if(el) el.style.display = 'none';
                });
                // Default to users tab
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('adminName').textContent = adminName || 'Admin';
                ['adminName2','adminName3','adminName4','adminName5','adminName6'].forEach(id => {
                    const el = document.getElementById(id); if(el) el.textContent = adminName || 'Admin';
                });
                const sn = document.getElementById('sidebarName'); if(sn) sn.textContent = adminName || 'Admin';
                const sa = document.getElementById('sidebarAvatar'); if(sa) sa.textContent = (adminName || 'A')[0].toUpperCase();
                loadStats();
                loadUsers();
                // Check if we should open a specific tab
                const urlParams = new URLSearchParams(window.location.search);
                const tabParam = urlParams.get('tab') || localStorage.getItem('adminTab');
                if (tabParam && TAB_MAP[tabParam]) { showTab(tabParam); }
                if (localStorage.getItem('adminTab')) localStorage.removeItem('adminTab');
            }
            // Auth handled by auth.js ‚Äî no else redirect needed
        };

        // ============ TICKET FUNCTIONS ============
        async function loadTicketStats() {
            try {
                const res = await fetch('/api/tickets/stats');
                const d = await res.json();
                document.getElementById('tStatTotal').textContent = d.total || 0;
                document.getElementById('tStatOpen').textContent = d.open || 0;
                document.getElementById('tStatProgress').textContent = d.in_progress || 0;
                document.getElementById('tStatResolved').textContent = d.resolved || 0;
                document.getElementById('tStatClosed').textContent = d.closed || 0;
                document.getElementById('tStatOverdue').textContent = d.overdue || 0;
                document.getElementById('tStatWarning').textContent = d.warning || 0;
            } catch(e) { console.error('Ticket stats error:', e); }
        }

        async function loadTickets() {
            const search = document.getElementById('ticketSearch').value;
            const status = document.getElementById('ticketStatusFilter').value;
            const priority = document.getElementById('ticketPriorityFilter').value;
            const tbody = document.getElementById('ticketTableBody');
            tbody.innerHTML = '<tr><td colspan="11" class="loading-spinner">Loading tickets...</td></tr>';

            try {
                let url = '/api/tickets?limit=50';
                if (search) url += '&search=' + encodeURIComponent(search);
                if (status) url += '&status=' + status;
                if (priority) url += '&priority=' + priority;
                
                const res = await fetch(url);
                const data = await res.json();
                const tickets = data.tickets || [];

                if (tickets.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="11" class="empty-state"><div class="empty-state-icon">üì≠</div><div>No tickets found</div></td></tr>';
                    return;
                }

                const priorityColors = {low:'#888',medium:'#ff8800',high:'#ff4444',urgent:'#ff0044'};
                const statusColors = {open:'#ff8800',in_progress:'#00aaff',resolved:'#00ff88',closed:'#666'};

                tbody.innerHTML = tickets.map(t => {
                    const rowStyle = t.is_overdue ? 'cursor:pointer;border-left:3px solid #ff4444;' : 'cursor:pointer;';
                    const slaCell = t.due_at ? (() => {
                        const due = new Date(t.due_at);
                        const now = new Date();
                        const diffMs = due - now;
                        const isOver = diffMs < 0;
                        const absDiff = Math.abs(diffMs);
                        const hr = Math.floor(absDiff / 3600000);
                        const mn = Math.floor((absDiff % 3600000) / 60000);
                        const label = isOver ? `${hr}h${mn}m overdue` : `${hr}h${mn}m left`;
                        const color = isOver ? '#ff4444' : (diffMs < 7200000 ? '#ffa500' : '#00ff88');
                        return `<span style="font-size:10px;font-weight:700;color:${color};">${isOver ? 'üö®' : (diffMs < 7200000 ? '‚ö†Ô∏è' : '‚è±')} ${label}</span>`;
                    })() : '<span style="font-size:10px;color:#666;">‚Äî</span>';
                    return `
                    <tr style="${rowStyle}" onclick="openTicketDetail(${t.id})">
                        <td style="color:var(--accent);font-weight:600;font-size:11px;">${t.ticket_number} ${t.escalated ? '<span style="color:#ff4444;font-size:9px;">‚¨Ü</span>' : ''}</td>
                        <td><div class="user-name">${t.user_name || 'Unknown'}</div><div class="user-email">${t.user_email}</div></td>
                        <td><span class="badge badge-info">${t.category}</span></td>
                        <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px;">${t.subject}</td>
                        <td><span style="color:${priorityColors[t.priority]||'#fff'};font-weight:700;text-transform:uppercase;font-size:10px;">${t.priority}</span></td>
                        <td><span class="badge" style="background:${statusColors[t.status]||'#333'}22;color:${statusColors[t.status]||'#fff'};border:1px solid ${statusColors[t.status]||'#333'}44;">${t.status.replace('_',' ')}</span></td>
                        <td>${slaCell}</td>
                        <td style="font-size:11px;color:var(--orange);">${t.department || '-'}</td>
                        <td style="font-size:11px;">${t.assigned_to || '<span style="color:var(--text-muted)">‚Äî</span>'}</td>
                        <td style="font-size:10px;">${formatDate(t.created_at)}</td>
                        <td><button class="btn btn-secondary btn-xs" onclick="event.stopPropagation();openTicketDetail(${t.id})">View</button></td>
                    </tr>
                `}).join('');
            } catch(e) {
                console.error('Load tickets error:', e);
                tbody.innerHTML = '<tr><td colspan="11" class="loading-spinner">Error loading tickets</td></tr>';
            }
        }

        async function openTicketDetail(ticketId) {
            try {
                const res = await fetch('/api/tickets/' + ticketId);
                const t = await res.json();

                document.getElementById('ticketModalTitle').textContent = t.ticket_number + ' ‚Äî ' + t.subject;

                const priorityColors = {low:'#888',medium:'#ff8800',high:'#ff4444',urgent:'#ff0044'};
                const statusColors = {open:'#ff8800',in_progress:'#00aaff',resolved:'#00ff88',closed:'#666'};

                // Load staff for assignment dropdown
                let staffOptions = '<option value="">Unassigned</option>';
                try {
                    const staffRes = await fetch('/api/staff');
                    const staffData = await staffRes.json();
                    (staffData.staff || []).filter(s => s.is_active).forEach(s => {
                        const sel = (t.assigned_staff_id === s.id) ? 'selected' : '';
                        staffOptions += '<option value="' + s.id + '" ' + sel + '>' + s.name + ' (' + s.department + ' - ' + s.role + ')</option>';
                    });
                } catch(e) { console.error('load staff for dropdown', e); }

                let html = `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
                    <div style="background:var(--bg-base);border-radius:var(--radius-sm);padding:10px;">
                        <div style="color:var(--text-muted);font-size:9px;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px;">User</div>
                        <div style="color:#fff;font-weight:600;font-size:12px;">${t.user_name||'Unknown'}</div>
                        <div style="color:var(--text-secondary);font-size:11px;">${t.user_email}</div>
                    </div>
                    <div style="background:var(--bg-base);border-radius:var(--radius-sm);padding:10px;">
                        <div style="color:var(--text-muted);font-size:9px;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px;">Info</div>
                        <div style="font-size:11px;"><span style="color:var(--text-muted);">Category:</span> <span style="color:var(--blue);">${t.category}</span></div>
                        <div style="font-size:11px;"><span style="color:var(--text-muted);">Priority:</span> <span style="color:${priorityColors[t.priority]};font-weight:700;">${t.priority.toUpperCase()}</span></div>
                        <div style="font-size:11px;"><span style="color:var(--text-muted);">Dept:</span> <span style="color:var(--orange);">${t.department || 'N/A'}</span></div>
                        <div style="font-size:11px;"><span style="color:var(--text-muted);">Source:</span> ${t.source}</div>
                    </div>
                </div>
                <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center;">
                    <select id="tdStatus" class="filter-select" style="font-size:11px;padding:5px 8px;">
                        <option value="open" ${t.status==='open'?'selected':''}>Open</option><option value="in_progress" ${t.status==='in_progress'?'selected':''}>In Progress</option><option value="waiting_user" ${t.status==='waiting_user'?'selected':''}>Waiting User</option><option value="resolved" ${t.status==='resolved'?'selected':''}>Resolved</option><option value="closed" ${t.status==='closed'?'selected':''}>Closed</option>
                    </select>
                    <select id="tdPriority" class="filter-select" style="font-size:11px;padding:5px 8px;">
                        <option value="low" ${t.priority==='low'?'selected':''}>Low</option><option value="medium" ${t.priority==='medium'?'selected':''}>Medium</option><option value="high" ${t.priority==='high'?'selected':''}>High</option><option value="urgent" ${t.priority==='urgent'?'selected':''}>Urgent</option>
                    </select>
                    <select id="tdAssignStaff" class="filter-select" style="font-size:11px;padding:5px 8px;flex:1;min-width:140px;">${staffOptions}</select>
                    <button class="btn btn-primary btn-xs" onclick="updateTicket(${t.id})">Update</button>
                </div>
                <div style="border-top:1px solid var(--border);padding-top:12px;margin-bottom:12px;">
                    <h4 style="color:var(--accent);margin-bottom:8px;font-size:12px;font-weight:700;">üí¨ Conversation</h4>
                    <div style="max-height:240px;overflow-y:auto;" id="msgThread">
                `;

                (t.messages||[]).forEach(m => {
                    const isAdmin = m.sender_type === 'admin';
                    html += `
                    <div style="display:flex;flex-direction:column;align-items:${isAdmin?'flex-end':'flex-start'};margin-bottom:8px;">
                        <div style="background:${isAdmin?'var(--accent-dim)':'var(--bg-base)'};border:1px solid ${isAdmin?'rgba(0,230,118,.2)':'var(--border)'};border-radius:var(--radius-sm);padding:8px 10px;max-width:85%;">
                            <div style="font-size:9px;color:${isAdmin?'var(--accent)':'var(--text-muted)'};margin-bottom:2px;font-weight:600;">${m.sender_name||m.sender_type} ¬∑ ${formatDate(m.created_at)}</div>
                            <div style="color:var(--text-secondary);font-size:12px;line-height:1.5;white-space:pre-wrap;">${m.message}</div>
                        </div>
                    </div>`;
                });

                html += `
                    </div>
                </div>
                <div style="display:flex;gap:6px;">
                    <textarea id="tdReply" placeholder="Type reply..." rows="2" style="flex:1;background:var(--bg-base);color:var(--text-primary);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px;font-size:12px;resize:vertical;font-family:inherit;"></textarea>
                    <button class="btn btn-primary btn-small" onclick="sendTicketReply(${t.id})" style="align-self:flex-end;">Send</button>
                </div>
                `;

                document.getElementById('ticketDetail').innerHTML = html;
                document.getElementById('ticketModal').classList.add('active');

                // Scroll messages to bottom
                setTimeout(() => {
                    const thread = document.getElementById('msgThread');
                    if(thread) thread.scrollTop = thread.scrollHeight;
                }, 100);

            } catch(e) {
                console.error('Ticket detail error:', e);
                alert('Error loading ticket details');
            }
        }

        async function updateTicket(ticketId) {
            try {
                const staffVal = document.getElementById('tdAssignStaff').value;
                const body = {
                    status: document.getElementById('tdStatus').value,
                    priority: document.getElementById('tdPriority').value,
                };
                if (staffVal) body.assigned_staff_id = parseInt(staffVal);
                else body.assigned_to = null;

                const res = await fetch('/api/tickets/' + ticketId, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                const d = await res.json();
                if (d.success) {
                    loadTicketStats();
                    loadTickets();
                    openTicketDetail(ticketId); // Refresh detail
                } else {
                    alert('Error updating ticket');
                }
            } catch(e) { alert('Error updating ticket'); }
        }

        async function sendTicketReply(ticketId) {
            const msg = document.getElementById('tdReply').value.trim();
            if (!msg) return;
            try {
                const res = await fetch('/api/tickets/' + ticketId + '/messages', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        sender_type: 'admin',
                        sender_name: adminName || 'Admin',
                        message: msg
                    })
                });
                const d = await res.json();
                if (d.success) {
                    openTicketDetail(ticketId);
                    loadTickets();
                } else {
                    alert('Error sending reply');
                }
            } catch(e) { alert('Error sending reply'); }
        }

        function closeTicketModal() {
            document.getElementById('ticketModal').classList.remove('active');
        }

        // ============ STAFF MANAGEMENT FUNCTIONS ============
        const roleBadges = {
            admin: {color:'#ff0044', label:'ADMIN'},
            manager: {color:'#ff8800', label:'MANAGER'},
            staff: {color:'#00aaff', label:'STAFF'},
        };

        const deptColors = {
            'IT': '#00ff88',
            'Operations': '#ff8800',
            'Finance': '#00aaff',
            'Marketing': '#ff44aa',
            'Customer Service': '#aa88ff',
        };

        async function loadDeptStats() {
            try {
                const res = await fetch('/api/staff');
                const data = await res.json();
                const staff = data.staff || [];

                const depts = {};
                staff.forEach(s => {
                    if (!depts[s.department]) depts[s.department] = {total:0, active:0, tickets:0};
                    depts[s.department].total++;
                    if (s.is_active) depts[s.department].active++;
                    depts[s.department].tickets += s.open_tickets || 0;
                });

                const container = document.getElementById('staffDeptStats');
                let html = '';
                for (const [dept, info] of Object.entries(depts)) {
                    const col = deptColors[dept] || '#00e676';
                    html += `
                    <div class="stat-card" style="border-top:2px solid ${col};">
                        <div class="stat-label">${dept}</div>
                        <div class="stat-value" style="color:${col};">${info.active}</div>
                        <div class="stat-sub">${info.tickets} tickets ¬∑ ${info.total} staff</div>
                    </div>`;
                }
                if (!html) html = '<div class="stat-card"><div class="stat-label">No staff yet</div><div class="stat-value">0</div><div class="stat-sub">Add your first staff member ‚Üí</div></div>';
                container.innerHTML = html;
            } catch(e) { console.error('Dept stats error:', e); }
        }

        async function loadStaff() {
            const dept = document.getElementById('staffDeptFilter').value;
            const role = document.getElementById('staffRoleFilter').value;
            const tbody = document.getElementById('staffTableBody');
            tbody.innerHTML = '<tr><td colspan="9" class="loading-spinner">Loading staff...</td></tr>';

            try {
                let url = '/api/staff?';
                if (dept) url += 'department=' + encodeURIComponent(dept) + '&';
                if (role) url += 'role=' + role;

                const res = await fetch(url);
                const data = await res.json();
                const staff = data.staff || [];

                if (staff.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="empty-state"><div class="empty-state-icon">üè¢</div><div>No staff members found</div></td></tr>';
                    return;
                }

                tbody.innerHTML = staff.map(s => {
                    const rb = roleBadges[s.role] || {color:'#666', label:s.role};
                    const dc = deptColors[s.department] || '#888';
                    const loadPct = s.max_tickets > 0 ? Math.round((s.open_tickets / s.max_tickets) * 100) : 0;
                    const loadColor = loadPct >= 80 ? '#ef5350' : loadPct >= 50 ? '#ffa726' : '#00e676';
                    return `
                    <tr>
                        <td style="color:var(--accent);font-weight:600;">${s.id}</td>
                        <td><div class="user-name">${s.name}</div><div class="user-email">${s.email}</div></td>
                        <td><span style="color:${dc};font-weight:600;font-size:11px;">${s.department}</span></td>
                        <td><span class="badge" style="background:${rb.color}18;color:${rb.color};border:1px solid ${rb.color}33;">${rb.label}</span></td>
                        <td>
                            <div style="display:flex;align-items:center;gap:6px;">
                                <span style="color:${loadColor};font-weight:700;font-size:11px;">${s.open_tickets}</span>
                                <div style="flex:1;height:4px;background:var(--bg-base);border-radius:2px;overflow:hidden;max-width:50px;">
                                    <div style="width:${loadPct}%;height:100%;background:${loadColor};border-radius:2px;transition:width .3s;"></div>
                                </div>
                            </div>
                        </td>
                        <td style="color:var(--text-muted);font-size:11px;">${s.max_tickets}</td>
                        <td>${s.is_active ? '<span class="badge badge-success">Active</span>' : '<span class="badge badge-danger">Off</span>'}</td>
                        <td style="font-size:10px;color:var(--text-muted);">${s.last_login ? formatDate(s.last_login) : 'Never'}</td>
                        <td><div class="actions"><button class="btn btn-secondary btn-xs" onclick="editStaff(${s.id})">Edit</button><button class="btn btn-danger btn-xs" onclick="deleteStaff(${s.id},'${s.name}')">Del</button></div></td>
                    </tr>`;
                }).join('');
            } catch(e) {
                console.error('Load staff error:', e);
                tbody.innerHTML = '<tr><td colspan="9" class="loading-spinner">Error loading staff</td></tr>';
            }
        }

        function openStaffModal(editMode = false) {
            document.getElementById('staffModalTitle').textContent = editMode ? 'Edit Staff' : 'Add Staff';
            document.getElementById('sfSubmitBtn').textContent = editMode ? 'Save Changes' : 'Create Staff';
            document.getElementById('sfPwHint').textContent = editMode ? 'Leave empty to keep current password' : '';
            document.getElementById('sfPassword').required = !editMode;
            if (!editMode) {
                document.getElementById('editStaffId').value = '';
                document.getElementById('sfName').value = '';
                document.getElementById('sfEmail').value = '';
                document.getElementById('sfPassword').value = '';
                document.getElementById('sfDept').value = 'IT';
                document.getElementById('sfRole').value = 'staff';
                document.getElementById('sfMaxTickets').value = '10';
                document.getElementById('sfActive').checked = true;
            }
            document.getElementById('staffModal').classList.add('active');
        }

        function closeStaffModal() {
            document.getElementById('staffModal').classList.remove('active');
        }

        async function editStaff(staffId) {
            try {
                const res = await fetch('/api/staff/' + staffId);
                const s = await res.json();
                document.getElementById('editStaffId').value = s.id;
                document.getElementById('sfName').value = s.name;
                document.getElementById('sfEmail').value = s.email;
                document.getElementById('sfEmail').readOnly = true;
                document.getElementById('sfPassword').value = '';
                document.getElementById('sfDept').value = s.department;
                document.getElementById('sfRole').value = s.role;
                document.getElementById('sfMaxTickets').value = s.max_tickets;
                document.getElementById('sfActive').checked = s.is_active;
                openStaffModal(true);
            } catch(e) { alert('Error loading staff info'); }
        }

        async function handleStaffSubmit(e) {
            e.preventDefault();
            const editId = document.getElementById('editStaffId').value;
            const isEdit = !!editId;

            const body = {
                name: document.getElementById('sfName').value,
                department: document.getElementById('sfDept').value,
                role: document.getElementById('sfRole').value,
                max_tickets: parseInt(document.getElementById('sfMaxTickets').value) || 10,
                is_active: document.getElementById('sfActive').checked,
            };

            if (isEdit) {
                const pw = document.getElementById('sfPassword').value;
                if (pw) body.new_password = pw;
                try {
                    const res = await fetch('/api/staff/' + editId, {
                        method: 'PUT',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify(body),
                    });
                    const d = await res.json();
                    if (d.success) { closeStaffModal(); loadStaff(); loadDeptStats(); }
                    else alert(d.detail || 'Error updating staff');
                } catch(e) { alert('Error updating staff'); }
            } else {
                body.email = document.getElementById('sfEmail').value;
                body.password = document.getElementById('sfPassword').value;
                try {
                    const res = await fetch('/api/staff', {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify(body),
                    });
                    const d = await res.json();
                    if (d.success) { closeStaffModal(); loadStaff(); loadDeptStats(); }
                    else alert(d.detail || 'Error creating staff');
                } catch(e) { alert('Error creating staff'); }
            }
        }

        async function deleteStaff(staffId, name) {
            if (!confirm('Delete staff member "' + name + '"? Their tickets will become unassigned.')) return;
            try {
                const res = await fetch('/api/staff/' + staffId, {method:'DELETE'});
                const d = await res.json();
                if (d.success) { loadStaff(); loadDeptStats(); }
                else alert(d.detail || 'Error deleting staff');
            } catch(e) { alert('Error deleting staff'); }
        }

        // ============ USER STATISTICS REPORT ============
        async function loadUserStatsReport() {
            try {
                const res = await fetch('/api/admin/reports/users?admin_token=' + adminToken);
                const d = await res.json();

                const t = d.totals;
                document.getElementById('userReportStats').innerHTML = `
                    <div class="stat-card"><div class="stat-icon">üë•</div><div class="stat-value">${t.total}</div><div class="stat-label">Total</div></div>
                    <div class="stat-card" style="border-top:2px solid var(--accent);"><div class="stat-icon">‚úÖ</div><div class="stat-value" style="color:var(--accent);">${t.active}</div><div class="stat-label">Active</div><div class="stat-sub">${t.inactive} inactive</div></div>
                    <div class="stat-card" style="border-top:2px solid var(--blue);"><div class="stat-icon">üìß</div><div class="stat-value" style="color:var(--blue);">${t.verified}</div><div class="stat-label">Verified</div><div class="stat-sub">${t.unverified} unverified</div></div>
                    <div class="stat-card" style="border-top:2px solid var(--orange);"><div class="stat-icon">üõ°Ô∏è</div><div class="stat-value" style="color:var(--orange);">${t.admins}</div><div class="stat-label">Admins</div></div>
                    <div class="stat-card" style="border-top:2px solid var(--purple);"><div class="stat-icon">üîë</div><div class="stat-value" style="color:var(--purple);">${d.login_stats.recent_logins_7d}</div><div class="stat-label">Logins (7d)</div><div class="stat-sub">${d.login_stats.never_logged_in} never</div></div>
                `;

                // Registration trend bar chart
                const trend = d.registration_trend || [];
                const maxCount = Math.max(...trend.map(t => t.count), 1);
                let chartHtml = '';
                trend.forEach(day => {
                    const height = Math.max((day.count / maxCount) * 100, 2);
                    const label = day.date.substring(5);
                    const color = day.count > 0 ? 'var(--accent)' : 'var(--border)';
                    chartHtml += `
                        <div style="display:flex;flex-direction:column;align-items:center;flex:1;min-width:14px;" title="${day.date}: ${day.count}">
                            <div style="font-size:8px;color:var(--text-muted);margin-bottom:2px;">${day.count || ''}</div>
                            <div style="width:100%;max-width:18px;height:${height}px;background:${color};border-radius:2px 2px 0 0;transition:height .3s;"></div>
                            <div style="font-size:7px;color:var(--text-muted);margin-top:2px;writing-mode:vertical-lr;transform:rotate(180deg);max-height:30px;overflow:hidden;">${label}</div>
                        </div>`;
                });
                document.getElementById('regTrendChart').innerHTML = chartHtml || '<div style="color:#666;text-align:center;width:100%;">No data</div>';

                document.getElementById('loginStatsBox').innerHTML = `
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        <div style="display:flex;justify-content:space-between;padding:8px 10px;background:var(--bg-base);border-radius:var(--radius-sm);">
                            <span style="color:var(--text-secondary);font-size:12px;">Active logins (7d)</span>
                            <span style="color:var(--accent);font-weight:700;font-size:12px;">${d.login_stats.recent_logins_7d}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:8px 10px;background:var(--bg-base);border-radius:var(--radius-sm);">
                            <span style="color:var(--text-secondary);font-size:12px;">Never logged in</span>
                            <span style="color:var(--red);font-weight:700;font-size:12px;">${d.login_stats.never_logged_in}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:8px 10px;background:var(--bg-base);border-radius:var(--radius-sm);">
                            <span style="color:var(--text-secondary);font-size:12px;">Login rate</span>
                            <span style="color:var(--blue);font-weight:700;font-size:12px;">${t.total > 0 ? Math.round(((t.total - d.login_stats.never_logged_in) / t.total) * 100) : 0}%</span>
                        </div>
                    </div>`;

                // Newest users
                let newestHtml = '';
                (d.newest_users || []).forEach((u, i) => {
                    newestHtml += `
                    <div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:${i%2===0?'var(--bg-base)':'transparent'};border-radius:var(--radius-sm);">
                        <div style="width:26px;height:26px;border-radius:50%;background:var(--accent-dim);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:700;font-size:10px;">${(u.name || '?')[0].toUpperCase()}</div>
                        <div style="flex:1;min-width:0;">
                            <div style="font-size:11px;font-weight:600;color:var(--text-primary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${u.name || 'N/A'}</div>
                            <div style="font-size:10px;color:var(--text-muted);">${u.email}</div>
                        </div>
                        <div style="font-size:9px;color:var(--text-muted);">${formatDate(u.created_at)}</div>
                    </div>`;
                });
                document.getElementById('newestUsersBox').innerHTML = newestHtml || '<div style="color:#666;text-align:center;padding:20px;">No users</div>';

            } catch(e) {
                console.error('User stats error:', e);
                document.getElementById('userReportStats').innerHTML = '<div class="stat-card"><div class="stat-label" style="color:#ff4444;">Error loading report</div></div>';
            }
        }

        // ============ WALLET REPORT ============
        async function loadWalletReport() {
            try {
                const res = await fetch('/api/admin/reports/wallet?admin_token=' + adminToken);
                const d = await res.json();

                // Summary stats
                const s = d.summary;
                document.getElementById('walletSummaryStats').innerHTML = `
                    <div class="stat-card" style="border-top:2px solid var(--accent);"><div class="stat-icon">üí∞</div><div class="stat-value" style="color:var(--accent);">RM ${s.total_balance.toFixed(2)}</div><div class="stat-label">Total Balance</div></div>
                    <div class="stat-card" style="border-top:2px solid var(--blue);"><div class="stat-icon">ü™ô</div><div class="stat-value" style="color:var(--blue);">${s.total_points.toLocaleString()}</div><div class="stat-label">Total Points</div></div>
                    <div class="stat-card" style="border-top:2px solid var(--orange);"><div class="stat-icon">üìä</div><div class="stat-value" style="color:var(--orange);">RM ${s.avg_balance}</div><div class="stat-label">Avg Balance</div></div>
                    <div class="stat-card"><div class="stat-icon">üëõ</div><div class="stat-value">${s.wallet_count}</div><div class="stat-label">Wallets</div></div>
                `;

                // Balance distribution as horizontal bars
                const dist = d.distribution;
                const distTotal = dist.zero + dist.low_1_10 + dist.mid_10_50 + dist.high_50_100 + dist.premium_100_plus || 1;
                const distItems = [
                    {label: 'RM 0', count: dist.zero, color: '#666'},
                    {label: 'RM 1‚Äì10', count: dist.low_1_10, color: '#ff8800'},
                    {label: 'RM 10‚Äì50', count: dist.mid_10_50, color: '#00aaff'},
                    {label: 'RM 50‚Äì100', count: dist.high_50_100, color: '#00ff88'},
                    {label: 'RM 100+', count: dist.premium_100_plus, color: '#ff44aa'},
                ];
                let distHtml = '';
                distItems.forEach(item => {
                    const pct = Math.round((item.count / distTotal) * 100);
                    distHtml += `
                    <div style="margin-bottom:8px;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:3px;">
                            <span style="font-size:11px;color:var(--text-secondary);">${item.label}</span>
                            <span style="font-size:11px;color:${item.color};font-weight:700;">${item.count} (${pct}%)</span>
                        </div>
                        <div style="height:5px;background:var(--bg-base);border-radius:3px;overflow:hidden;">
                            <div style="width:${pct}%;height:100%;background:${item.color};border-radius:3px;transition:width .4s;"></div>
                        </div>
                    </div>`;
                });
                document.getElementById('balanceDistChart').innerHTML = distHtml;

                // Top wallets
                let topHtml = '';
                (d.top_wallets || []).forEach((w, i) => {
                    const medals = ['ü•á','ü•à','ü•â'];
                    const medal = i < 3 ? medals[i] : `<span style="color:var(--text-muted);font-size:10px;">#${i+1}</span>`;
                    topHtml += `
                    <div style="display:flex;align-items:center;gap:8px;padding:6px 8px;background:${i%2===0?'var(--bg-base)':'transparent'};border-radius:var(--radius-sm);">
                        <div style="width:22px;text-align:center;font-size:14px;">${medal}</div>
                        <div style="flex:1;min-width:0;">
                            <div style="font-size:11px;font-weight:600;color:var(--text-primary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${w.name}</div>
                            <div style="font-size:10px;color:var(--text-muted);">${w.email}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="color:var(--accent);font-weight:700;font-size:12px;">RM ${w.balance.toFixed(2)}</div>
                            <div style="color:var(--orange);font-size:10px;">${w.points} pts</div>
                        </div>
                    </div>`;
                });
                document.getElementById('topWalletsBox').innerHTML = topHtml || '<div style="color:#666;text-align:center;padding:20px;">No wallets</div>';

                // Recent transactions
                const tbody = document.getElementById('walletTxnBody');
                const txns = d.recent_transactions || [];
                if (txns.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><div class="empty-state-icon">üí≥</div><div>No transactions yet</div></td></tr>';
                } else {
                    const typeColors = {topup:'#00ff88',payment:'#ff4444',refund:'#00aaff',reward:'#ff8800',deduction:'#ff4444'};
                    tbody.innerHTML = txns.map(t => `
                        <tr>
                            <td style="font-size:13px;">${t.user}</td>
                            <td><span style="background:${(typeColors[t.type]||'#888')}22;color:${typeColors[t.type]||'#888'};padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;text-transform:uppercase;">${t.type}</span></td>
                            <td style="color:${t.amount>=0?'#00ff88':'#ff4444'};font-weight:600;">RM ${t.amount.toFixed(2)}</td>
                            <td style="font-size:13px;color:#aaa;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t.description || '-'}</td>
                            <td style="font-size:12px;color:#888;">${formatDate(t.created_at)}</td>
                        </tr>
                    `).join('');
                }
            } catch(e) {
                console.error('Wallet report error:', e);
                document.getElementById('walletSummaryStats').innerHTML = '<div class="stat-card"><div class="stat-label" style="color:#ff4444;">Error loading report</div></div>';
            }
        }

        // ============ ACTIVITY LOG ============
        let _allActivityEvents = [];

        async function loadActivityLog() {
            const timeline = document.getElementById('activityTimeline');
            timeline.innerHTML = '<div style="text-align:center;padding:40px;color:#888;">Loading activity log...</div>';
            try {
                const res = await fetch('/api/admin/reports/activity?admin_token=' + adminToken);
                const d = await res.json();
                _allActivityEvents = d.events || [];
                filterActivityLog();
            } catch(e) {
                console.error('Activity log error:', e);
                timeline.innerHTML = '<div style="text-align:center;padding:40px;color:#ff4444;">Error loading activity log</div>';
            }
        }

        function filterActivityLog() {
            const filter = document.getElementById('activityTypeFilter').value;
            const events = filter ? _allActivityEvents.filter(e => e.type === filter) : _allActivityEvents;
            const timeline = document.getElementById('activityTimeline');

            if (events.length === 0) {
                timeline.innerHTML = '<div style="text-align:center;padding:40px;color:#666;">No events found</div>';
                return;
            }

            const typeColors = {
                registration: '#00ff88', login: '#00aaff', session: '#ff8800',
                ticket: '#aa88ff', maintenance: '#ff4444', staff_login: '#ff44aa'
            };

            let html = '';
            let lastDate = '';
            events.forEach(ev => {
                const evDate = ev.time ? ev.time.substring(0, 10) : 'Unknown';
                if (evDate !== lastDate) {
                    lastDate = evDate;
                    html += `<div style="color:var(--text-muted);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;padding:10px 0 6px;border-bottom:1px solid var(--border);margin-bottom:6px;">${evDate}</div>`;
                }
                const col = typeColors[ev.type] || '#888';
                html += `
                <div style="display:flex;gap:10px;padding:8px 6px;border-bottom:1px solid rgba(30,42,58,.4);transition:background .15s;" onmouseover="this.style.background='var(--bg-base)'" onmouseout="this.style.background='transparent'">
                    <div style="width:28px;height:28px;border-radius:var(--radius-sm);background:${col}12;border:1px solid ${col}28;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;">${ev.icon}</div>
                    <div style="flex:1;min-width:0;">
                        <div style="font-size:12px;color:var(--text-primary);margin-bottom:1px;">${ev.desc}</div>
                        <div style="font-size:10px;color:var(--text-muted);">${ev.detail || ''}</div>
                    </div>
                    <div style="font-size:9px;color:var(--text-muted);white-space:nowrap;flex-shrink:0;">${ev.time ? formatDate(ev.time) : ''}</div>
                </div>`;
            });

            timeline.innerHTML = html;
        }

        // Initialize
        checkAuth();
    </script>
</body>
</html>
