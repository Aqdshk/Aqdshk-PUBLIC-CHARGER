# ============================================
# PlagSini EV — Local Development (Hot-Reload)
# Usage: docker compose up -d
#
# Volume mounts enabled — edit code locally,
# changes auto-detected (no rebuild needed).
#
# Only rebuild when dependencies change:
#   docker compose up -d --build
# ============================================

services:
  mysql:
    image: mysql:8.0
    container_name: charging-platform-mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-rootpassword}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-charging_platform}
      - MYSQL_USER=${MYSQL_USER:-charging_user}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-charging_password}
    ports:
      - "3307:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./init_docker_mysql.sql:/docker-entrypoint-initdb.d/02-init-extra.sql:ro
    networks:
      - ev-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-rootpassword}"]
      interval: 10s
      timeout: 5s
      retries: 5

  charging-platform:
    build:
      context: ./ChargingPlatform
      dockerfile: Dockerfile
    container_name: charging-platform
    ports:
      - "8000:8000"
      - "9000:9000"
    volumes:
      # ── Dev volume mount: local code → container ──
      # Edit files locally, uvicorn --reload picks up changes automatically.
      # Only requirements.txt / Dockerfile changes need rebuild.
      - ./ChargingPlatform:/app
      - charging-platform-data:/app/data
    # Override CMD with --reload for dev hot-reload
    # uvicorn watches /app for file changes and auto-restarts
    command: ["uvicorn", "api:app", "--host", "0.0.0.0", "--port", "8000", "--reload", "--reload-dir", "/app"]
    environment:
      - DATABASE_URL=mysql+pymysql://${MYSQL_USER:-charging_user}:${MYSQL_PASSWORD:-charging_password}@mysql:3306/${MYSQL_DATABASE:-charging_platform}
      - PYTHONUNBUFFERED=1
      - DEV_AUTO_INIT=1
      - SMTP_HOST=${SMTP_HOST:-smtp.gmail.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_EMAIL=${SMTP_EMAIL:-aqidishak28@gmail.com}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-uvcz akom aiul jjct}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME:-PlagSini EV}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-plagsini-ev-jwt-secret-change-me-in-production-2026}
      - CORS_ORIGINS=${CORS_ORIGINS:-}
    networks:
      - ev-network
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped

  customer-service:
    build:
      context: ./CustomerService
      dockerfile: Dockerfile
    container_name: customer-service
    ports:
      - "8001:8001"
    volumes:
      # ── Dev volume mount: local code → container ──
      - ./CustomerService:/app
    # Override CMD with --reload for dev hot-reload
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8001", "--reload", "--reload-dir", "/app"]
    environment:
      - DATABASE_URL=mysql+pymysql://${MYSQL_USER:-charging_user}:${MYSQL_PASSWORD:-charging_password}@mysql:3306/customer_service
      - PYTHONUNBUFFERED=1
      - CHARGING_PLATFORM_URL=http://charging-platform:8000
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
    networks:
      - ev-network
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped

  appev:
    build:
      context: ./AppEV
      dockerfile: Dockerfile
    container_name: appev
    ports:
      - "3000:80"
    # Note: Flutter web uses multi-stage build (build → Nginx static).
    # Volume mount not practical here — rebuild needed for Flutter changes:
    #   docker compose build appev && docker compose up -d appev
    networks:
      - ev-network
    depends_on:
      - charging-platform
    restart: unless-stopped

networks:
  ev-network:
    driver: bridge

volumes:
  charging-platform-data:
  mysql-data:
